---
interface Props {
	bookings: string[];
}

const { bookings } = Astro.props;
---

<div class="availability-calendar" data-bookings={JSON.stringify(bookings)}>
    <div class="availability-header">
        <button class="availability-nav" aria-label="Previous month" data-action="prev">
            <svg width="16" height="16" viewBox="0 0 20 20" fill="none" aria-hidden="true">
                <path d="M12 4L6 10L12 16" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>

        <h3 class="availability-title">
            <span class="availability-month"></span>
            <span class="availability-year"></span>
        </h3>

        <button class="availability-nav" aria-label="Next month" data-action="next">
            <svg width="16" height="16" viewBox="0 0 20 20" fill="none" aria-hidden="true">
                <path d="M8 4L14 10L8 16" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>
    </div>

    <div class="availability-grid">
        <div class="availability-day-header">M</div>
        <div class="availability-day-header">T</div>
        <div class="availability-day-header">W</div>
        <div class="availability-day-header">T</div>
        <div class="availability-day-header">F</div>
        <div class="availability-day-header">S</div>
        <div class="availability-day-header">S</div>
        <div class="availability-days"></div>
    </div>

    <div class="availability-legend">
    <span class="legend-item">
      <span class="legend-circle legend-circle--available"></span>
      Available
    </span>
        <span class="legend-item">
      <span class="legend-circle legend-circle--booked"></span>
      Booked
    </span>
    </div>
</div>

<script>
	const MONTHS = [
		'January', 'February', 'March', 'April', 'May', 'June',
		'July', 'August', 'September', 'October', 'November', 'December'
	];

	function getCalendarDays(year: number, month: number) {
		const firstDay = new Date(year, month, 1);
		const lastDay = new Date(year, month + 1, 0);
		const daysInMonth = lastDay.getDate();
		const startingDay = (firstDay.getDay() + 6) % 7;

		const days: { date: number; isCurrentMonth: boolean; fullDate: string }[] = [];

		const prevMonth = month === 0 ? 11 : month - 1;
		const prevYear = month === 0 ? year - 1 : year;
		const prevMonthLastDay = new Date(prevYear, prevMonth + 1, 0).getDate();

		for (let i = startingDay - 1; i >= 0; i--) {
			const date = prevMonthLastDay - i;
			days.push({
				date,
				isCurrentMonth: false,
				fullDate: `${prevYear}-${String(prevMonth + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`
			});
		}

		for (let i = 1; i <= daysInMonth; i++) {
			days.push({
				date: i,
				isCurrentMonth: true,
				fullDate: `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`
			});
		}

		const nextMonth = month === 11 ? 0 : month + 1;
		const nextYear = month === 11 ? year + 1 : year;
		const remaining = 42 - days.length;

		for (let i = 1; i <= remaining; i++) {
			days.push({
				date: i,
				isCurrentMonth: false,
				fullDate: `${nextYear}-${String(nextMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`
			});
		}

		return days;
	}

	document.querySelectorAll('.availability-calendar').forEach(calendar => {
		const bookingsData: string[] = JSON.parse(calendar.getAttribute('data-bookings') || '[]');
		const prevBtn = calendar.querySelector('[data-action="prev"]');
		const nextBtn = calendar.querySelector('[data-action="next"]');
		const monthEl = calendar.querySelector('.availability-month');
		const yearEl = calendar.querySelector('.availability-year');
		const daysContainer = calendar.querySelector('.availability-days');

		const now = new Date();
		let year = now.getFullYear();
		let month = now.getMonth();

		const today = new Date();
		const todayString = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

		function isBooked(date: string): boolean {
			return bookingsData.includes(date);
		}

		function renderCalendar() {
			if (!monthEl || !yearEl || !daysContainer) return;

			monthEl.textContent = MONTHS[month];
			yearEl.textContent = String(year);

			const days = getCalendarDays(year, month);

			daysContainer.innerHTML = days.map(day => {
				const booked = isBooked(day.fullDate);
				const isToday = day.fullDate === todayString;

				const classes = [
					'day-circle',
					!day.isCurrentMonth ? 'day-circle--other' : '',
					booked ? 'day-circle--booked' : 'day-circle--available',
					isToday ? 'day-circle--today' : ''
				].filter(Boolean).join(' ');

				return `<div class="${classes}" data-date="${day.fullDate}">${day.date}</div>`;
			}).join('');
		}

		prevBtn?.addEventListener('click', () => {
			month--;
			if (month < 0) {
				month = 11;
				year--;
			}
			renderCalendar();
		});

		nextBtn?.addEventListener('click', () => {
			month++;
			if (month > 11) {
				month = 0;
				year++;
			}
			renderCalendar();
		});

		renderCalendar();
	});
</script>

<style>
    .availability-calendar {
        max-width: 360px;
        margin: var(--space-lg) auto 0;
    }

    .availability-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-md);
    }

    .availability-nav {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        background: transparent;
        border: 1px solid var(--chrome-dark);
        border-radius: 2px;
        color: var(--chrome-mid);
        cursor: pointer;
        transition: all var(--transition-base);
    }

    .availability-nav:hover {
        border-color: var(--chrome-mid);
        color: var(--chrome-light);
    }

    .availability-nav:focus-visible {
        outline: 2px solid var(--nav-hover);
        outline-offset: 2px;
    }

    .availability-title {
        display: flex;
        gap: var(--space-xs);
        font-size: var(--text-base);
        font-weight: 300;
        letter-spacing: 0.1em;
        color: var(--chrome-light);
    }

    .availability-year {
        color: var(--chrome-mid);
    }

    .availability-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: var(--space-xs);
    }

    .availability-day-header {
        font-size: var(--text-xs);
        font-weight: 400;
        letter-spacing: 0.1em;
        color: var(--text-muted);
        text-align: center;
        padding-bottom: var(--space-sm);
    }

    .availability-days {
        display: contents;
    }

    :global(.day-circle) {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: var(--text-xs);
        font-weight: 400;
        letter-spacing: 0.02em;
        transition: all var(--transition-base);
        margin: 0 auto;
    }

    :global(.day-circle--available) {
        border: 1px solid var(--border-visible);
        background: transparent;
        color: var(--text-secondary);
    }

    :global(.day-circle--booked) {
        border: none;
        background: var(--chrome-darkest);
        color: var(--text-muted);
    }

    :global(.day-circle--today) {
        border: 2px solid var(--accent-warm);
    }

    :global(.day-circle--today.day-circle--booked) {
        box-shadow: 0 0 0 2px var(--accent-warm);
    }

    :global(.day-circle--other) {
        opacity: 0.25;
    }

    .availability-legend {
        display: flex;
        justify-content: center;
        gap: var(--space-lg);
        margin-top: var(--space-lg);
        padding-top: var(--space-md);
        border-top: 1px solid var(--border-subtle);
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        font-size: var(--text-xs);
        color: var(--text-muted);
        letter-spacing: 0.05em;
    }

    .legend-circle {
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }

    .legend-circle--available {
        border: 1px solid var(--border-visible);
        background: transparent;
    }

    .legend-circle--booked {
        background: var(--chrome-darkest);
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce) {
        .availability-nav,
        :global(.day-circle) {
            transition: none;
        }
    }
</style>
